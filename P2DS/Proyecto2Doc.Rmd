---
title: "Proyecto 2 DataScience"
author: "Grupo 6"
date: "28 de agosto de 2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Resumen de información
En los avances de proyecto 1, se había presentado el análisis exploratorio del archivo equivocado. Por ello, el primer paso fue realizar análisis exploratorio sobre los archivos que incluyen únicamente las ventas por sector, así como la distribución de cada sector. 


## Objetivos
* Separar las ventas por sectores.
* Crear una predicción sobre la ventas a partir de líneas de tiempo generadas con los datos que se tienen por sector de los últimos 4 años.
* Verificar la eficiencia del modelo comparando las gráficas de tiempo con la historia económica de los últimos 4 años.

## Variables de interés
* Ventas: es una variable cuantitativa la cual será clave para las predicciones.
* Mes y año de venta: variable cuantitativa indispensable para la creación de una serie de tiempo. 
* Sector: variable de carácter cualitativo dado que indica la pertenencia de una venta a un sector asignado en un país.

## Variables Respuesta
* Modelo de predicción a partir de la serie de tiempo. 

```{r echo=FALSE, warning=FALSE, include=FALSE}
# Librerias a utilizar
require(ggpubr) # Para mejorar la visualización gráfica
require(tidyverse) # Para explotar, manipular y visualizar datos que comparten info
require(corrplot) # Para visualizar la matriz de correlación
require(cluster) #Para calcular la silueta
library(fpc) # Para hacer el plotcluster
library(NbClust) # Para determinar el numero de clusters optimo
library(factoextra) # Para hacer graficos bonitos de clustering
library(rela) # Para poder utilizar paf()
library(psych) # Para poder utilizar KMO()
#library(FactoMineR)
library(corrplot)
library(REdaS)
library(ggplot2) # Graficas bonitas
#library(ggpubr) # Graficas bonitas x2
#library(ggmap)
library(arules) # Reglas de asociacion
library(factoextra) 
library(arulesViz)
library(dplyr)
#library(caret) # Muestreo estratificado
library(class) # Para KNN
library(e1071) # Requisito para la matriz de confusión
library(openxlsx)
library(plyr)
```
```{r echo=FALSE}
#"/Users/quiebres/Documents/Ivan Maldonado/UVG/Sexto Semestre/Data Science/Proyecto2DS"
# /Users/odalisrg/Documents/Semestre 6/Data Science/Proyecto2DS/P2DS
# F:/Data Science/Proyecto 2/Proyecto2DS
#C:/Users/Betzy/Documents/Betzy/Proyecto2DS
setwd("C:/Users/Betzy/Documents/Betzy/Proyecto2DS/P2DS")

# Leyendo el dataset de csv importacion
# Guatemala

SecG <- read.xlsx("USG1519.xlsx", sheet = 1, startRow = 1, colNames = TRUE,
                 rowNames = FALSE, detectDates = FALSE, skipEmptyRows = TRUE,
                 skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                 namedRegion = NULL, na.strings = "0", fillMergedCells = FALSE)

DescG <- read.xlsx("USG1519.xlsx", sheet = 2, startRow = 1, colNames = TRUE,
                 rowNames = FALSE, detectDates = FALSE, skipEmptyRows = TRUE,
                 skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                 namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE)

# Leyendo el dataset de csv importacion
# Honduras

SecH <- read.xlsx("USH1519.xlsx", sheet = 1, startRow = 1, colNames = TRUE,
                 rowNames = FALSE, detectDates = FALSE, skipEmptyRows = TRUE,
                 skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                 namedRegion = NULL, na.strings = "0", fillMergedCells = FALSE)

DescH <- read.xlsx("USH1519.xlsx", sheet = 2, startRow = 1, colNames = TRUE,
                 rowNames = FALSE, detectDates = FALSE, skipEmptyRows = TRUE,
                 skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                 namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE)

# Leyendo el dataset de csv importacion
# Nicaragua

SecN <- read.xlsx("USN1519.xlsx", sheet = 1, startRow = 1, colNames = TRUE,
                 rowNames = FALSE, detectDates = FALSE, skipEmptyRows = TRUE,
                 skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                 namedRegion = NULL, na.strings = "0", fillMergedCells = FALSE)

DescN <- read.xlsx("USN1519.xlsx", sheet = 2, startRow = 1, colNames = TRUE,
                 rowNames = FALSE, detectDates = FALSE, skipEmptyRows = TRUE,
                 skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                 namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE)

# Leyendo el dataset de csv importacion
# El Salvador

SecS <- read.xlsx("USS1519.xlsx", sheet = 1, startRow = 1, colNames = TRUE,
                 rowNames = FALSE, detectDates = FALSE, skipEmptyRows = TRUE,
                 skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                 namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE)

DescS <- read.xlsx("USS1519.xlsx", sheet = 2, startRow = 1, colNames = TRUE,
                 rowNames = FALSE, detectDates = FALSE, skipEmptyRows = TRUE,
                 skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                 namedRegion = NULL, na.strings = "0", fillMergedCells = FALSE)
```
```{r}
SecG[is.na(SecG)] <- 0
SecH[is.na(SecH)] <- 0
SecN[is.na(SecN)] <- 0
SecS[is.na(SecS)] <- 0
```

### Cambio de nombre a las columnas

```{r}
# 
cambioTitulos <- function(x){
# -------------------------------
# Títulos principales
# -------------------------------
  names(x)[1] <- "Sector"
  names(x)[2] <- "Categoria"
  names(x)[length(x)] <- "VentasTotales"
  x <- x[-c(1, 2), ]
  x <- x[,c(1,2,length(x))]
}

SecS <- cambioTitulos(SecS)
SecS$VentasTotales <- as.numeric(SecS$VentasTotales)




#Guatemala

Gde <- c('0000','0001','0002','0003','0004','0005','0006','0007','0008','0009','0010','0011', '0012', '0013', '0014', '0015', '0016', '0017', '0018', '0019', '0020','0021', '0022', '0023', '0024', '0025', '0026', '0027', '0028', '0029', '0030', '0031', '0032', '0033', '0034', '0035', '0036', '0037', '0038', '0039', '0040', '0041', '0042', '0043', 'AB01','AB02', 'AB03', 'CC', 'EX01', 'PR01')
Ga <- c('0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49')

SecG <- cambioTitulos(SecG)
SecG$Sector <- gsub2(Gde,Ga,SecG$Sector)


SecH <- cambioTitulos(SecH)

#Nicaragua

Nde <- c('0000', '0402', '0403', '0404', '0405', '0406', '0407', '0408', '0409', '0410', '0411', '0412', '0413', '0420', '0421', '0422', '0423', '0424', '0425', '0426', '0427', '0428', '0429', '0430', '0431', '0433', 'AB01', 'CC')

Na <- c('0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27')

SecN <- cambioTitulos(SecN)
SecN$Sector <- gsub2(Nde, Na, SecN$Sector)
SecS <- cambioTitulos(SecS)
```


```{r echo=FALSE}

#vector de sectores
## Guatemala

sectoresG <- strsplit(DescG[,c(2)], "-")
sectoresG <- data.frame(sectoresG)
sectoresG <- t(sectoresG[-c(2),])

## Honduras
sectoresH <- strsplit(DescH[,c(2)], "-")
sectoresH <- data.frame(sectoresH)
sectoresH <- t(sectoresH[-c(2),])

## Nigaragua

sectoresN <- strsplit(DescN[,c(2)], "-")
sectoresN <- data.frame(sectoresN)
sectoresN <- t(sectoresN[-c(2),])


```

# Sumando las ventas por sector


```{r}
sectoresG <- gsub(" ","", sectoresG)
crearLista <- function(x,y){
  lista <-c()
  for(i in seq(1, length(y), by=1)){
    sec <- subset(x, Sector == y[i])
    sec <- sec[,c(length(x))]
    lista[[i]] <- sum(as.numeric(sec))
  }
  return(lista)
}

Guatemala <- as.data.frame(crearLista(SecG, sectoresG))
```

# Categorias que mas/menos venden
## Guatemala 
```{r}
SecG$VentasTotales <- as.numeric(SecG$VentasTotales) 
catG <- ddply(SecG, .(Categoria), summarize, sum=sum(VentasTotales))
catG<- catG[-c(1),] 

ggplot(data=catG, aes(x=Categoria, y=sum)) +
  geom_bar(stat="identity")+ coord_flip() 
```
Se tiene que las categorias que mas venden son: Uso diario, cabello y ellas. 
En cuanto a las que menos venden se tiene que: cuidado personal, kimberly clark y paquetes.

## El Salvador

```{r}
SecS$VentasTotales <- as.numeric(SecS$VentasTotales) 
catS <- ddply(SecS, .(Categoria), summarize, sum=sum(VentasTotales))

catS<- catS[-c(1),] 

ggplot(data=catS, aes(x=Categoria, y=sum)) +
  geom_bar(stat="identity")+ coord_flip() 

```
Nuevamente, se tiene que entre las que mas venden son: uso diario, cabello y ellas. 
Entre las que menos venden se tienen: Joyeria, premios y paquetes.
## Nicaragua
```{r}
SecN$VentasTotales <- as.numeric(SecN$VentasTotales) 
catN <- ddply(SecN, .(Categoria), summarize, sum=sum(VentasTotales))
catN<- catN[-c(1),] 

ggplot(data=catN, aes(x=Categoria, y=sum)) +
  geom_bar(stat="identity")+ coord_flip() 

```
## Honduras
```{r}
SecH$VentasTotales <- as.numeric(SecH$VentasTotales) 
catH <- ddply(SecN, .(Categoria), summarize, sum=sum(VentasTotales))
catH<- catN[-c(1),] 

ggplot(data=catH, aes(x=Categoria, y=sum)) +
  geom_bar(stat="identity")+ coord_flip() 

```


# PCA entre las categorias que mas venden


#Sneak peak: Series de tiempo

```{r}
# -------------------------------
# Distrito 1 de Nicaragua
# -------------------------------
CC01 <- Nica2[,c(1)]
D1.ts <- ts (CC01,start = c(2015,2), end=c(2019,5), frequency = 12)
plot(D1.ts)
# RESUMEN: hay declives a fines de año, se observan ventas inferiores a 200
# Descomponiendo la serie
D1.ts.desc <- decompose(D1.ts)
plot(D1.ts.desc)
# RESUMEN: no hay tendencia pero no es estacionaria con la media. Es oscilatoria
```
Este distrito se llama "CONTADO INSTITUCIONAL". Las ventas máximas de este distrito ha sido de 700, que solamente se logró a mediados del año 2015. La segunda venta más alta ha sido en los primeros meses del 2017 pero sin sobrepasar las 600 ventas unitarias.
Ahora, al ver la descomposición de la serie, se observa que ha sido oscilatoria la tendencia. En los últimos meses, ha tenido más tendencia de lo usual. En este caso, es posible tomar en cuenta los altos y bajos de este distrito. 


```{r}
# -------------------------------
# Distrito 2 de Nicaragua
# -------------------------------
D01 <- Nica2[,c(2:12)]
D01 <- rowSums(D01)

D2.ts <- ts (D01,start = c(2015,1), end=c(2019,5), frequency = 12)
plot(D2.ts)
# RESUMEN: Ha incrementado desde el 2017 y se ha mantenido más o menos estable
# Descomponiendo la serie
D2.ts.desc <- decompose(D2.ts)
plot(D2.ts.desc)
# RESUMEN: Hay tendencia y es un poco estacionaria con la media (pero no del todo!!)
```
Este distrito se llama "INDIANA RIVAS". Se observa que los ventas han ido creciendo y se han logrado estabilizar desde el 2017. Las ventas más bajas han sido de 40,000 y lo máximo de 60,000. Con respecto a la descomposición, se observa que fue oscilatoria pero que ha logrado estabilizarse (posiblemente es un comportamiento logístico). 


```{r}
# -------------------------------
# Distrito 3 de Nicaragua
# -------------------------------
D02 <- Nica2[,c(13:24)]
D02 <- rowSums(D02)

D3.ts <- ts (D02,start = c(2015,1), end=c(2019,5), frequency = 12)
plot(D3.ts)
# RESUMEN: Es una de las más "estables", a finales de año no exceden de 45,000 ventas
# Descomponiendo la serie
D3.ts.desc <- decompose(D3.ts)
plot(D3.ts.desc)
# RESUMEN: Hay tendencia pero se mira un comportamiento logístico, como que ya logró más o menos estabilizarse
```
Este distrito se llama "JANNETTE HERRERA". Las ventas unitarias han sido crecientes, mostrando que las ventas a principios del año han sido más altas con respecto a los años pasados. En la descomposición de la serie, se muestra tendencia y estable con la media, ya que no se observan picos notables.


```{r}
# -------------------------------
# Distrito 4 de Nicaragua
# -------------------------------
D03 <- Nica2[,c(25)]

D4.ts <- ts (D03,start = c(2015,1), end=c(2019,5), frequency = 12)
plot(D4.ts)
# RESUMEN: No es estable, hay muchos picos
D4.ts.desc <- decompose(D4.ts)
plot(D4.ts.desc)
# RESUMEN: Hay bastante decrecimiento en las ventas... 
```
Este distrito se llama "INSTITUCIONAL". Las ventas han ido de forma decreciente en comparación de las ventas del 2016-2017. Se observa que en los últimos meses se ha presenciado un declive en esta serie, las ventas más bajas se sitúan a mediados del 2018; poco a poco, las ventas fueron creciendo pero de manera lenta. Es importante tomar en cuenta si esta serie va a volver a presentar un declive o no; ver si es oscilatoria o no. Con respecto a la descomposición, no muestra tendencia, solo un decrecimiento en las ventas.

```{r}
# -------------------------------
# Distrito 5 de Nicaragua
# -------------------------------
D0AB <- Nica2[,c(26)]

D5.ts <- ts (D0AB,start = c(2015,1), end=c(2019,5), frequency = 12)
plot(D5.ts)
# RESUMEN: Esta rara
D5.ts.desc <- decompose(D5.ts)
plot(D5.ts.desc)
# RESUMEN: Hay muuuuucha tendencia en los ultimos años

```
Este distrito se llama "DISTRITO ABOGADOS". Okay, evidentemente este distrito ha solicitado muchos productos de Scentia desde el 2018 hasta este año. El crecimiento de ventas ha sido de forma radical, mostrando solamente que en el mes de diciembre del 2018 las ventas bajaron pero luego crecieron nuevamente, superando las ventas del 2018. Tomar en cuenta porqué se debe este cambio. Claramente se evidencia tendencia, aunque es estacionaria con la media pero no con la varianza. 

```{r}
# -------------------------------
# Distrito 6 de Nicaragua
# -------------------------------
D0EM <- Nica2[,c(27)]

D6.ts <- ts (D0EM,start = c(2015,1), end=c(2019,5), frequency = 12)
plot(D6.ts)
# RESUMEN: Jajaja esta suuper decreciente 
D6.ts.desc <- decompose(D6.ts)
plot(D6.ts.desc)
# RESUMEN: Hay bastante decrecimiento en las ventas... 
```
Este distrito se llama "DISTRITO EMPLEADO". Este distrito ha perido muchas ventas, siendo estas casi nulas. Comenzó todo bien pero desde principios del 2016, las ventas han ido decreciendo. En la descomposición se observa claramente este bajón en las ventas, posiblemente es útil considerar eliminar este distrito dentro de las ventas destinadas que tiene contemplado Scentia o simplemente se podrían producir lo necesario para satisfacer este distrito y que la empresa no tenga pérdidas. 
